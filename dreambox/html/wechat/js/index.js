function mxClose(){WeixinJSBridge.invoke("closeWindow",{},function(){})}!function(){var e=function(){var e=navigator.userAgent;return{ios:!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:e.indexOf("Android")>-1||e.indexOf("Linux")>-1}}();e.ios&&!function(){var e=document.body;document.body.onfocus=function(t){var o=t.target.nodeName.toLowerCase();("input"===o||"textarea"===o||"select"===o)&&(e.querySelector(".footerTool").style.display="none")},document.body.onblur=function(t){var o=t.target.nodeName.toLowerCase();("input"===o||"textarea"===o||"select"===o)&&(e.querySelector(".footerTool").style.display="block")}}();var t=angular.module("app",["ngRoute","ngResource"]);t.value("mx.pageUrl",pageUrl),t.config(["$routeProvider","$locationProvider",function(e,t){e.when("/login",{controller:"mx.login",templateUrl:"login.html"}).when("/regist",{controller:"mx.regist",templateUrl:"regist.html"}).when("/redEnvelopes",{controller:"mx.redEnvelopes",templateUrl:"redEnvelopes.html"}).when("/intro",{controller:"mx.intro",templateUrl:"intro.html"}).when("/share",{controller:"mx.share",templateUrl:"share.html"}).when("/protocol",{controller:"mx.protocol",templateUrl:"protocol.html"}).when("/selectCourse",{controller:"mx.selectCourse",templateUrl:"selectCourse.html"}).when("/signin",{controller:"mx.signin",templateUrl:"signin.html"}).when("/forgotPassword",{controller:"mx.forgotPassword",templateUrl:"forgotPassword.html"}).when("/bindPhone",{controller:"mx.bindPhone",templateUrl:"bindPhone.html"}).when("/selectCourseNow",{controller:"mx.selectCourseNow",templateUrl:"selectCourseNow.html"}).otherwise("/404"),t.hashPrefix("!")}]),t.controller("mx.selectCourseNow",["$scope","$rootScope","$controller","mx.Modal","mx.pageUrl","mx.Ajax","$location",function(e,t,o,n,a,i,r){var s={};s.save=a.nowSign,s.deleteSC=a.deleteSC,s.classHour=a.classHour,angular.extend(this,o("mx.selectCourse",{$scope:e,"mx.pageUrl":s})),t.title="实时签到",t.bodyBg=!1,t.selectCourseNowData?(e.list=t.selectCourseNowData,angular.forEach(e.list,function(e){e.selectText="选择课时"}),t.selectCourseNowData=null):n.jumpPage("没有实时签到数据","/intro"),e.selectClassHour=function(t){e.activeData.hours_name=t.title,e.activeData.hours_id=t.ch_id,e.activeData.selectText=t.title},e.submit=function(){var o,s;s=[],angular.forEach(e.list,function(e){e.hours_name&&s.push({course_name:e.course_name,sc_id:e.sc_id,time:""+e.lesson_date+"("+e.week_day+")",term_id:e.term_id,grade_name:e.grade_name,class_name:e.class_num,section_num:e.section_name,hours_name:e.hours_name})}),o={text:"确认签到",text2:s[0].course_name+"("+s[0].grade_name+s[0].class_name+"班)",ok:function(){var e;e=new i(a.nowSign),e.post({saveData:s}).$promise.then(function(e){if(1===e.code){var o="签到成功";""!==e.msg&&(o=e.msg),t.signinData=e.data,r.path("/signin")}else 2===e.code?n.jumpPage(e.msg,"/login"):n.flashModal(e.msg)})}},n.comfirmModal(o)},e._selectClassHour=function(t){e.selectClassHour(t),e.submit()}}]),t.controller("mx.redEnvelopes",["$scope","$rootScope","mx.Ajax",function(e,t,o){t.title="红包查询",t.bodyBg=!1;var n=1;if(e.showMore=!1,e.userData={},e.list=[],t.userData)e.userData=t.userData;else{var a=new o(pageUrl.userInfo);a.dataProces({type:"uname,avatar_url,money"}).then(function(o){t.userData={};for(var n in o)e.userData[n]=t.userData[n]=o[n]})}var i=new o(pageUrl.winningList);e.getPageData=function(){i.dataProces({page:n}).then(function(t){var o=e.list,a=[].push;if(e.showMore=n<t.count?!0:!1,n++,0!==o.length){var i,r,s,c=o[o.length-1],l=t.list[0];for(s in l)"$$hashKey"!=s&&(r=s);for(s in c)"$$hashKey"!=s&&(i=s);r===i&&(a.apply(c[i],l[r]),t.list.splice(0,1))}a.apply(o,t.list)})},e.getPageData()}]),t.controller("mx.selectCourse",["$scope","$rootScope","mx.Ajax","mx.Modal","$location","$window","mx.pageUrl",function(e,t,o,n,a,i,r){t.title="课程签到",t.bodyBg=!1,e.noSelect="",e.list=e.classHourList=[],e.activeData=null,e.scrollTop=0,r.selectCourse&&!function(){var t=new o(r.selectCourse);t.dataProces({}).then(function(t){return t&&0!==t.length?(angular.forEach(t,function(e){e.selectText="选择课时"}),e.list=t,i.document.body.style.visibility="hidden",i.setTimeout(function(){i.document.body.style.visibility="visible"},100),void 0):(e.noSelect="暂时没有需要签到的课程",!1)})}(),e["delete"]=function(t){var a,i;i=t.sc_id,a={text:"您确定没上该节课",ok:function(){var a;a=new o(r.deleteSC),a.dataProces({sc_id:i}).then(function(){var o,a;n.flashModal("删除课程成功"),a=e.list,o=a.indexOf(t),a.splice(o,1)})}},n.comfirmModal(a)},e.select=function(t){e.activeData=t,e.scrollTop=i.document.body.scrollTop;var n=new o(r.classHour);n.dataProces({sc_id:t.course_id}).then(function(t){var o,n,a;for(n=0,a=t.length;a>n;n++){if(o=t[n],o.ch_id===e.activeData.hours_id){o.isActive=!0;break}o.isActive=!1}e.classHourList=t,i.setTimeout(function(){i.document.body.scrollTop=0},1)})},e.submit=function(i){var s,c;return c=[],angular.forEach(e.list,function(e){e.hours_name&&c.push({course_name:e.course_name,sc_id:e.sc_id,time:""+e.lesson_date+"("+e.week_day+")",term_id:e.term_id,grade_name:e.grade_name,class_name:e.class_num,section_num:e.section_name,hours_name:e.hours_name})}),0===c.length?(n.flashModal("请选择签到课时"),!1):(i||(i="您已经选择了"+c.length+"节课的课时"),s={text:i,ok:function(){var e;e=new o(r.save);var i=n.loading();e.post({saveData:c}).$promise.then(function(e){if(i(),i=null,1===e.code){var o="签到成功";""!==e.msg&&(o=e.msg),t.signinData=e.data,a.path("/signin")}else 2===e.code?n.jumpPage(e.msg,"/login"):n.flashModal(e.msg)},function(){i(),i=null})}},n.comfirmModal(s),void 0)},e.selectClassHour=function(t){e.activeData.hours_name=t.title,e.activeData.hours_id=t.ch_id,e.activeData.selectText=t.title,e.activeData=null,e.classHourList.length=0,i.setTimeout(function(){i.document.body.scrollTop=e.scrollTop},1)},e.backCourseList=function(){e.classHourList.length=0,i.setTimeout(function(){i.document.body.scrollTop=e.scrollTop},1)}}]),t.controller("mx.login",["$scope","$rootScope","$http","$location","mx.Modal","mx.Ajax","$timeout",function(e,t,o,n,a,i){t.title="梦想盒子登录",t.bodyBg="white",e.data={},e.word={},e.data.userid="",e.word.userid="用户名不能为空或格式不正确",e.data.password="",e.word.password="密码不能为空",e.submit=function(){var t,o;for(o in e.data)if(!e.data[o])return a.flashModal(e.word[o]),!1;t=new i(pageUrl.login),t.dataProces(e.data).then(function(){n.path("/intro")})}}]),t.controller("mx.signin",["$scope","$rootScope","mx.Ajax","mx.Modal","$location",function(e,t,o,n,a){t.title="签到成功",t.bodyBg=!1,t.signinData?(e.data=t.signinData,t.signinData=null):a.path("/intro")}]),t.controller("mx.share",["$scope","$rootScope","mx.Ajax","mx.Modal","$location","mx.Imgmin","$window","mx.cookie",function(t,o,n,a,i,r,s,c){o.title="分享",o.bodyBg=!1,t.data={},t.data.images=[],t.minImages=[],t.data.content="",t.data.tags=[],t.browser=e.ios&&!e.android,t.imagesSize={width:668,height:null},t.tagsShow=!1;var l=c.get("hateSelectCourseNow");if(o.images){new r({file:o.images,height:t.imagesSize.height,width:t.imagesSize.width,img:function(e){t.$apply(function(){t.data.images.push(e)})}})}var d=new n(pageUrl.getTag);d.dataProces({}).then(function(e){t.tags=e}),t.selectTag=function(e){var o,n=t.data.tags;if(e.active)o=n.indexOf(e.id),n.splice(o,1),e.active=!e.active;else{if(n.length>=3)return a.flashModal("最多选择3个标签"),!1;n.push(e.id),e.active=!e.active}},t.del=function(e){a.comfirmModal({text:"确认删除这张图片",ok:function(){t.$apply(function(){t.data.images.splice(e,1),t.minImages.splice(e,1)})}})},t.submit=function(){if(t.browser){if(0===t.data.images.length)return a.flashModal("请添加图片"),!1}else if(""===t.data.content.trim())return a.flashModal("说点什么呗..."),!1;var e=new n(pageUrl.shareBlog);e.dataProces(t.data).then(function(e){"true"!==l&&e&&angular.isArray(e)&&0!==e.length?(o.selectCourseNowData=e,i.path("/selectCourseNow")):i.path("/intro")})}}]),t.controller("mx.intro",["$scope","$rootScope","mx.Ajax","mx.Modal","$routeParams","$location","$timeout","$filter",function(t,o,n,a,i,r,s,c){o.title="梦想盒子",o.bodyBg=!1;var l={Monday:"星期一",Tuesday:"星期二",Wednesday:"星期三",Thursday:"星期四",Friday:"星期五",Saturday:"星期六",Sunday:"星期日"};t.today=function(){var e=new Date,t=e.getTime(),o=c("date")(t,"yyyy-MM-dd"),n=c("date")(t,"EEEE");return n=l[n],o+" "+n}(),function(){var e=new n(pageUrl.index);e.dataProces({}).then(function(e){var n;t.data=e,o.userData=e,n=i.mask,"1"===n&&(a.jumpPage("您已登陆"),r.search("mask",null))})}(),t.browser=e.ios&&!e.android,t.jump=function(e){o.images=e.files[0],s(function(){r.path("/share")},1)}}]),t.controller("mx.protocol",["$scope","$rootScope","mx.Ajax","mx.Modal","$sce",function(e,t,o,n,a){var i;t.title="真爱梦想网络服务协议",t.bodyBg=!1;var r=n.loading();i=new o(pageUrl.protocol),i.post({}).$promise.then(function(t){r(),t.data?e.data=a.trustAsHtml(t.data):n.flashModal(t.msg)},function(){r()})}]),t.controller("mx.forgotPassword",["$scope","$rootScope","$controller",function(e,t,o){angular.extend(this,o("mx.regist",{$scope:e})),t.title="找回密码"}]),t.controller("mx.bindPhone",["$scope","$rootScope","mx.Ajax","mx.Modal",function(e,t,o,n){t.title="绑定手机号",t.bodyBg="white",e.data={},e.word={},e.data.phone="",e.word.phone="手机号不能为空或格式不正确",e.data.code="",e.word.code="请填写短信验证码",t.userData&&t.userData.uname||!function(){var e=new o(pageUrl.userInfo);e.dataProces({type:"uname"}).then(function(e){t.userData={};for(var o in e)t.userData[o]=e[o]})}(),e.submit=function(t){for(var a in e.data)if(!e.data[a])return n.flashModal(e.word[a]),!1;var i=new o(pageUrl[t]);sendData={},angular.forEach(e.data,function(e,t){sendData[t]=e}),i.dataProces(sendData).then(function(){n.jumpPage("绑定成功","/intro")})}}]),t.controller("mx.regist",["$scope","$rootScope","$http","$location","mx.Modal","mx.Ajax","$timeout","$window",function(e,t,o,n,a,i){t.title="梦想盒子注册",t.bodyBg="white",e.data={},e.word={},e.data.phone="",e.word.phone="手机号不能为空或格式不正确",e.data.password="",e.word.password="密码不能为空",e.data.code="",e.word.code="请填写短信验证码",e.partChecked=!0,e.codeWord="获取验证码";var r=/\s/i;e.submit=function(t){var o,s,c;if(e.partChecked!==!0)return a.flashModal("请同意注册协议"),!1;for(s in e.data)if(!e.data[s])return a.flashModal(e.word[s]),!1;return r.test(e.data.password)?(a.flashModal("密码不能包含空格"),!1):(o=new i(pageUrl[t]),c={},angular.forEach(e.data,function(e,t){c[t]=e}),o.dataProces(c).then(function(e){n.path("/"+e.url)}),void 0)}}]),t.factory("mx.Ajax",["$resource","$q","mx.Modal","$routeParams","$rootScope","$timeout","$location","$document",function(e,t,o,n,a,i,r,s){if(!a.openId){var c=document.createElement("script");a.openId=n.openId,c.src="../../online_check.php?openid="+a.openId+"&action=trace&from=wechat",s[0].body.appendChild(c)}var l=function(){function t(t){this.url=t,this.resource=e(this.url,{},{})}return t}();return l.prototype.post=function(e){return e.openId=a.openId,this.resource.save({},e)},l.prototype.dataProces=function(e){var n,a,i=o.loading();return a=t.defer(),n=this.post(e),n.$promise.then(function(e){i(),1===e.code?a.resolve(e.data):2===e.code?o.jumpPage(e.msg,"/login"):o.flashModal(e.msg)},function(){i()}),a.promise},l}]),t.directive("mxHref",["$location","$window",function(e){return{scope:{mxHref:"@"},link:function(t,o){o.bind("click",function(){t.$apply(function(){e.path(t.mxHref)})})}}}]),t.directive("mxGetCode",["mx.Ajax","mx.Modal","$window",function(e,t,o){return{replace:!0,template:'<a href="javascript:;">{{codeWord}}</a>',scope:{url:"@mxGetCode",phone:"="},link:function(n,a){var i,r=new e(pageUrl[n.url]);n.codeWord="获取验证码";var s=/1[0-9]{10}/i;a.on("click",function(){return i?!1:n.phone?s.test(n.phone)?(r.dataProces({phone:n.phone}).then(function(){var e,a;t.flashModal("发送成功"),a=60,e=0,i=o.setInterval(function(){++e,n.$apply(function(){60>e?n.codeWord=""+(a-e)+"秒后重新获取":(n.codeWord="获取验证码",o.clearInterval(i),i=null)})},1e3)}),void 0):(t.flashModal("请填写正确的手机号码"),!1):(t.flashModal("请填写手机号码"),!1)})}}}]),t.directive("mxShowPassword",["$document",function(e){return{link:function(t,o){var n="ontouchstart"in window?"touchstart":"mousedown",a="ontouchend"in window?"touchend":"mouseup";o.on(n,function(t){var o=t.currentTarget,n=o.parentNode.querySelector('input[type="password"]');n.type="text",e.on(a,function i(){n.type="password",e.off(a,i)})})}}}]),t.factory("mx.cookie",["$document",function(e){var t=e[0];return{set:function(e,o,n){var a=e+"="+escape(o);if(n>0){var i=new Date;i.setTime(n),a+=";expires="+i.toGMTString()}t.cookie=a},get:function(e){var o=t.cookie;if(o.length>0){var n,a=o.indexOf(e+"=");if(-1!=a)return a=a+e.length+1,n=o.indexOf(";",a),-1==n&&(n=o.length),unescape(o.substring(a,n))}return""},del:function(e){var o=new Date;o.setTime(o.getTime()-1e4),t.cookie=e+"=a;expires="+o.toGMTString()}}}]),t.directive("mxHate",["mx.cookie","$filter","$location",function(e,t,o){return{link:function(n,a){a.on("click",function(){var a=new Date,i=a.getTime();i=a.getTime()+864e5,i=t("date")(i,"MM/dd/yyyy"),i=new Date(i).getTime(),e.set("hateSelectCourseNow","true",i),n.$apply(function(){o.path("/intro")})})}}}]),t.directive("mxUpload",["$timeout","mx.Modal","mx.Imgmin",function(e,t,o){return{scope:{imgList:"=",imgWidth:"@",imgHeight:"@"},link:function(e,n){n.bind("change",function(n){if(n.preventDefault(),"image/gif"===n.target.files[0].type)return t.flashModal("不支持gif图片上传"),!1;{var a=t.loading();new o({file:n.target.files[0],height:e.imgHeight,width:e.imgWidth,img:function(t){a(),e.$parent.$apply(function(){e.imgList.push(t)})}})}})}}}]),t.factory("mx.Imgmin",["$window",function(e){function t(t){for(var o in t)this[o]=t[o];this.canvas=e.document.createElement("canvas"),this._min()}return t.prototype._min=function(){var e=this,t=new MegaPixImage(e.file);EXIF.getData(e.file,function(){var o=this.exifdata.Orientation;t.render(e.canvas,{maxWidth:e.width,maxHeight:e.height,orientation:o},function(){e.img(e.canvas.toDataURL(e.file.type))})})},t}]),t.factory("mx.Modal",["$timeout","$document","$window","$location",function(e,t,o,n){var a,i,r,s;return r='<div class="flashModal fade"><p></p></div>',s='<div class="pageJump"><div class="bg fade"></div><div class="text"><div class="icon"><span class="icon-uniE60C"></span><span class="icon-uniE60C"></span><span class="icon-uniE60C"></span></div><p></p></div></div>',i='<div class="mask fade"><div class="comfirmModal"><div class="text"><i>?</i><span></span></div><div class="btn-group"><a href="javascript:;" class="cancel">取消</a><a class="ok" href="javascript:;">确定</a></div></div></div>',loadingHtml='<div class="mask" style="background:url(images/loading.gif) no-repeat center rgba(255,255,255,0.2);"></div>',a=t.find("body"),{flashModal:function(t){var o;o=angular.element(r),o.find("p").text(t),a.append(o),o.bind("click",function(){o.remove()}),e(function(){o.addClass("in")}),e(function(){o.removeClass("in")},3e3),e(function(){o.remove()},4e3)},jumpPage:function(t,o){var i,r;r=angular.element(s),r[0].querySelector("p").innerHTML=t,a.append(r),i=r[0].querySelector(".bg"),e(function(){i.classList.add("in")}),e(function(){i.classList.remove("in")},2e3),e(function(){r.remove(),o&&n.path(o)},2200)},loading:function(){var e=document.body,t=angular.element(loadingHtml);return e.appendChild(t[0]),function(){t.remove()}},comfirmModal:function(t){var o,n,r;n=angular.element(i);var s=n[0].querySelector(".text");if(s.querySelector("span").innerHTML=t.text,t.text2){var c=document.createElement("p");c.className="gray smallFont mt10",c.innerHTML=t.text2,s.appendChild(c)}o=n[0].querySelector(".cancel"),r=n[0].querySelector(".ok"),angular.element(o).bind("click",function(){return n.remove(),t.cancel&&t.cancel(),!1}),angular.element(r).bind("click",function(){return n.remove(),t.ok&&t.ok(),!0}),n.bind("click",function(e){e.target===n[0]&&o.click()}),a.append(n),e(function(){n.addClass("in")},1)}}}])}();